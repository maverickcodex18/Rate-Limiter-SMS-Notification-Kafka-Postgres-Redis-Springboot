###############################################################################
# Rate-Limited SMS Gateway — API Test Cases
# Base URL: http://localhost:8080
#
# Run order matters for some tests (e.g., send before config → 404).
# Tests are grouped by endpoint and scenario.
###############################################################################


###############################################################################
# 1. POST /api/config — HAPPY PATH
###############################################################################

### 1.1 Create new user config
# Expected: 200, response contains userId=1001, rateLimit=5, timeWindow=1, currentCount=0
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": 5,
  "timeWindow": 1
}

### 1.2 Create another user config (different user)
# Expected: 200, userId=1002
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1002,
  "rateLimit": 3,
  "timeWindow": 2
}

### 1.3 Update existing user config (upsert — resets currentCount to 0)
# Expected: 200, rateLimit=9, currentCount=0 (reset)
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": 9,
  "timeWindow": 1
}

### 1.4 Config with minimum valid values (boundary)
# Expected: 200, rateLimit=1, timeWindow=1
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 0,
  "rateLimit": 1,
  "timeWindow": 1
}

### 1.5 Config with large rateLimit
# Expected: 200
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 2000,
  "rateLimit": 100,
  "timeWindow": 2
}


###############################################################################
# 2. POST /api/config — VALIDATION ERRORS (400)
###############################################################################

### 2.1 Negative userId (@Min(0) violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": -1,
  "rateLimit": 5,
  "timeWindow": 1
}

### 2.2 Zero rateLimit (@Min(1) violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": 0,
  "timeWindow": 1
}

### 2.3 Negative rateLimit
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": -5,
  "timeWindow": 1
}

### 2.4 Zero timeWindow (@Min(1) violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": 5,
  "timeWindow": 0
}

### 2.5 Negative timeWindow
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1001,
  "rateLimit": 5,
  "timeWindow": -3
}

### 2.6 Missing rateLimit field
# Expected: 400 (defaults to 0 which violates @Min(1))
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1002,
  "timeWindow": 1
}

### 2.7 Missing timeWindow field
# Expected: 400 (defaults to 0 which violates @Min(1))
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 1002,
  "rateLimit": 5
}

### 2.8 Empty request body
# Expected: 400
POST http://localhost:8080/api/config
Content-Type: application/json

{}

### 2.9 No body at all
# Expected: 400
POST http://localhost:8080/api/config
Content-Type: application/json


###############################################################################
# 3. POST /api/send — HAPPY PATH
###############################################################################

### 3.0 Setup: Create user with rateLimit=3, timeWindow=1 for send tests
# Expected: 200
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 5001,
  "rateLimit": 3,
  "timeWindow": 1
}

### 3.1 Send message — first request (within limit)
# Expected: 200 "Message Sent Successfully"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "Hello, this is message 1"
}

### 3.2 Send message — second request (within limit)
# Expected: 200 "Message Sent Successfully"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "Hello, this is message 2"
}

### 3.3 Send message — third request (last allowed, hits limit)
# Expected: 200 "Message Sent Successfully"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "Hello, this is message 3"
}


###############################################################################
# 4. POST /api/send — RATE LIMIT EXCEEDED (429)
###############################################################################

### 4.1 Send message — fourth request (exceeds limit of 3)
# Expected: 429 "Rate Limit Exceeded"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "This should be rate limited"
}

### 4.2 Send again — still rate limited
# Expected: 429 "Rate Limit Exceeded"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "Still rate limited"
}


###############################################################################
# 5. POST /api/send — USER NOT FOUND (404)
###############################################################################

### 5.1 Send to non-existent user
# Expected: 404 "User not found"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 9999,
  "message": "No config exists for this user"
}

### 5.2 Send to another non-existent user
# Expected: 404 "User not found"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 0,
  "message": "User 0 might not be configured"
}


###############################################################################
# 6. POST /api/send — VALIDATION ERRORS (400)
###############################################################################

### 6.1 Negative userId (@Min(0) violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": -1,
  "message": "Invalid user"
}

### 6.2 Blank message (@NotBlank violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": ""
}

### 6.3 Whitespace-only message (@NotBlank violation)
# Expected: 400 "Missing/Invalid Arguments"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001,
  "message": "   "
}

### 6.4 Missing message field
# Expected: 400
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 5001
}

### 6.5 Empty request body
# Expected: 400
POST http://localhost:8080/api/send
Content-Type: application/json

{}

### 6.6 No body at all
# Expected: 400
POST http://localhost:8080/api/send
Content-Type: application/json


###############################################################################
# 7. LAZY REFRESH — Window Expiry Resets Counter
###############################################################################

### 7.0 Setup: Create user with rateLimit=2, timeWindow=1 (1 minute window)
# Expected: 200
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 7001,
  "rateLimit": 2,
  "timeWindow": 1
}

### 7.1 Send first message
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 7001,
  "message": "Window test msg 1"
}

### 7.2 Send second message (hits limit)
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 7001,
  "message": "Window test msg 2"
}

### 7.3 Send third message (should be rate limited)
# Expected: 429 "Rate Limit Exceeded"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 7001,
  "message": "Should be blocked"
}

### 7.4 WAIT 1+ MINUTE, then send again (lazy refresh should reset counter)
# Expected: 200 "Message Sent Successfully" (counter reset to 1)
# NOTE: Wait at least 1 minute before running this request
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 7001,
  "message": "After window expiry — should succeed"
}


###############################################################################
# 8. CONFIG UPDATE RESETS COUNTER
###############################################################################

### 8.0 Setup: Create user and exhaust limit
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 8001,
  "rateLimit": 1,
  "timeWindow": 60
}

### 8.1 Send one message (exhausts limit of 1)
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 8001,
  "message": "Exhaust the limit"
}

### 8.2 Verify rate limited
# Expected: 429
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 8001,
  "message": "Should be blocked"
}

### 8.3 Re-configure user (resets currentCount to 0)
# Expected: 200, currentCount=0
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 8001,
  "rateLimit": 5,
  "timeWindow": 60
}

### 8.4 Send again after config update (should succeed — counter was reset)
# Expected: 200 "Message Sent Successfully"
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 8001,
  "message": "After config update — counter reset"
}


###############################################################################
# 9. MULTI-USER ISOLATION
###############################################################################

### 9.0 Setup user A with limit=1
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 9001,
  "rateLimit": 1,
  "timeWindow": 60
}

### 9.1 Setup user B with limit=1
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 9002,
  "rateLimit": 1,
  "timeWindow": 60
}

### 9.2 User A sends (exhausts limit)
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 9001,
  "message": "User A message"
}

### 9.3 User A rate limited
# Expected: 429
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 9001,
  "message": "User A blocked"
}

### 9.4 User B sends (should succeed — independent of User A)
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 9002,
  "message": "User B message — unaffected by User A"
}

### 9.5 User B rate limited
# Expected: 429
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 9002,
  "message": "User B blocked"
}


###############################################################################
# 10. EDGE CASES — RATE LIMIT = 1 (Boundary)
###############################################################################

### 10.0 Setup: rateLimit=1
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 10001,
  "rateLimit": 1,
  "timeWindow": 5
}

### 10.1 First send — exactly at limit
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 10001,
  "message": "Only one allowed"
}

### 10.2 Second send — immediately blocked
# Expected: 429
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 10001,
  "message": "Should be blocked immediately"
}


###############################################################################
# 11. EDGE CASES — LARGE MESSAGE PAYLOAD
###############################################################################

### 11.1 Send with a long message
# Expected: 200 (no max length validation on message, just @NotBlank)
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 1001,
  "message": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur."
}


###############################################################################
# 12. CONFIG IDEMPOTENCY — Same config twice
###############################################################################

### 12.1 Create config
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 12001,
  "rateLimit": 10,
  "timeWindow": 5
}

### 12.2 Same config again (upsert — should reset currentCount to 0)
# Expected: 200, currentCount=0
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 12001,
  "rateLimit": 10,
  "timeWindow": 5
}


###############################################################################
# 13. RAPID FIRE — Same user, multiple sends (manual concurrency test)
# Run these as fast as possible to test rate limiting under quick succession
###############################################################################

### 13.0 Setup: rateLimit=2
POST http://localhost:8080/api/config
Content-Type: application/json

{
  "userId": 13001,
  "rateLimit": 2,
  "timeWindow": 5
}

### 13.1 Rapid send 1
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 13001,
  "message": "Rapid 1"
}

### 13.2 Rapid send 2
# Expected: 200
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 13001,
  "message": "Rapid 2"
}

### 13.3 Rapid send 3
# Expected: 429
POST http://localhost:8080/api/send
Content-Type: application/json

{
  "userId": 13001,
  "message": "Rapid 3 — should be blocked"
}
